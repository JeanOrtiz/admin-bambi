<template>
  <div class="page-container" id="products-page">
    <form @submit.prevent="searchProduct" class="search-form">
      <input
        ref="searchInput"
        class="input"
        placeholder="Nombre, marca, codigo"
        type="text"
      />
    </form>

    <b-table
      :paginated="true"
      :pagination-simple="true"
      :per-page="perPage"
      :data="products"
      :striped="true"
      :hoverable="true"
      :loading="loading"
      :checked-rows.sync="checkedProducts"
      :sticky-header="true"
      height="75vh"
      checkable
      @check="setActionButtons()"
    >
      <template slot-scope="props">
        <b-table-column field="id" label="ID" width="40" numeric>{{
          props.row.id
        }}</b-table-column>

        <b-table-column field="name" label="Nombre">
          <strong>{{ props.row.name }}</strong>
        </b-table-column>

        <b-table-column field="brand" label="Marca">{{
          props.row.brand
        }}</b-table-column>

        <b-table-column field="unit" label="Presentación">
          <b-tag type="is-primary">
            {{ props.row.content }}
            {{ props.row.unit }}
          </b-tag>
        </b-table-column>

        <b-table-column field="codebar" label="Código">{{
          props.row.codebar
        }}</b-table-column>

        <b-table-column field="categories" label="Categorías">
          <b-taglist>
            <b-tag
              v-for="(cat, i) in props.row.categories"
              :key="`catg-${i}`"
              v-text="cat"
              type="is-info"
            />
          </b-taglist>
        </b-table-column>
        <b-table-column field="product" label="Acciones">
          <div class="field is-grouped">
            <div class="control">
              <button
                @click="openUpdateForm(props.row)"
                class="button is-success is-small is-rounded"
              >
                <i class="mdi mdi-pencil"></i>
              </button>
            </div>
            <div class="control">
              <button
                @click="showProduct(props.row)"
                class="button is-info is-small is-rounded"
              >
                <i class="mdi mdi-eye"></i>
              </button>
            </div>
            <div class="control">
              <button
                @click="openUpdateForm(props.row)"
                class="button is-danger is-small is-rounded"
              >
                <i class="mdi mdi-delete"></i>
              </button>
            </div>
          </div>
        </b-table-column>
      </template>

      <template slot="empty">
        <section class="section">
          <div class="content has-text-grey has-text-centered">
            <p>
              <b-icon icon="package-variant" size="is-large"></b-icon>
            </p>
            <p>No hay productos para mostrar.</p>
          </div>
        </section>
      </template>
    </b-table>

    <!-- Product modal form -->
    <b-modal :active.sync="showForm" has-modal-card>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Agregar un nuevo producto</p>
        </header>
        <section class="modal-card-body">
          <product-form :show="showForm" @submit="saveProduct" />
        </section>
      </div>
    </b-modal>

    <!-- Product edit form -->
    <b-modal :active.sync="showUpdateForm" has-modal-card>
      <div v-if="selectedProduct" class="modal-card">
        <header class="modal-card-head">
          <span class="modal-card-title" v-text="selectedProduct.name" />
        </header>
        <section class="modal-card-body">
          <product-form
            :product-id="selectedProduct.id"
            @submit="updateProduct"
          />
        </section>
      </div>
    </b-modal>

    <!-- Product detail modal -->
    <b-modal :active.sync="showDetailModal" has-modal-card>
      <div class="modal-card" v-if="showDetailModal">
        <section class="modal-card-body">
          <product-detail :id="selectedProductId" />
        </section>
      </div>
    </b-modal>

    <!-- Add to inventory -->
    <b-modal :active.sync="showInventoryModal" has-modal-card :width="1024">
      <div class="modal-card is-full-width">
        <header class="modal-card-head">
          <span class="modal-card-title">Importar multiples productos</span>
        </header>
        <section class="modal-card-body" style="overflow: hidden">
          <ImportProducts :products="checkedProducts" />
        </section>
      </div>
    </b-modal>
  </div>
</template>

<script>
import ProductForm from '@/components/product/Form.vue'
import ProductDetail from '@/components/product/ProductDetail.vue'
import EventBus from '@/event-bus'
import ImportProducts from '@/components/inventory/ImportProducts.vue'

export default {
  name: 'products',

  components: {
    ProductForm,
    ProductDetail,
    ImportProducts
  },

  data() {
    return {
      products: [],
      loading: true,
      showForm: false,
      perPage: 50,
      selectedProduct: undefined,
      selectedProductId: undefined,
      showUpdateForm: false,
      showDetailModal: false,
      checkedProducts: [],
      // Inventory form
      inventories: [],
      showInventoryModal: false,
      selectedInventory: undefined
    }
  },

  computed: {},

  methods: {
    // Get all products
    getProducts() {
      Database.product
        .toArray()
        .then(products => (this.products = products))
        .then(() => (this.loading = false))
    },

    /**
     * Handle product submit form
     */
    saveProduct(data) {
      // Append timestaps
      const now = new Date()
      data.created_at = now.toISOString()
      data.updated_at = now.toISOString()

      Database.product
        .add(data)
        .then(product => {
          // Save the product
          this.getProducts()
          this.showForm = false
        })
        .catch(err => console.log(err))
    },

    updateProduct(data) {
      Database.product.update(data.id, data).then(() => {
        this.showUpdateForm = false
        this.getProducts()
        this.$buefy.toast.open({
          message: 'Se actualizó el producto',
          type: 'is-success',
          position: 'is-bottom'
        })
      })
    },

    openUpdateForm(product) {
      this.selectedProduct = product
      this.showUpdateForm = true
      EventBus.$emit('SELECT_PROJECT_UPDATE')
    },

    searchProduct() {
      const value = this.$refs.searchInput.value
      if (value.length) {
        Database.product
          .where('name')
          .startsWithIgnoreCase(value)
          .or('brand')
          .startsWithIgnoreCase(value)
          .or('codebar')
          .startsWithIgnoreCase(value)
          .toArray(products => (this.products = products))
      } else {
        this.getProducts()
      }
    },

    showProduct(product) {
      this.selectedProductId = product.id
      this.showDetailModal = true
    },

    getInventories() {
      Database.inventory.toArray(data => (this.inventories = data))
    },

    /**
     * Add Products to selected Inventory
     */
    addProducts() {
      let inventoryProducts = this.checkedProducts.map(product => {
        return {
          product_id: product.id,
          inventory_id: this.selectedInventory
        }
      })

      Database.inventory_product
        .bulkAdd(inventoryProducts)
        .then(() => {
          this.showToast(
            `Se agregaron ${inventoryProducts.length} al inventario`
          )
          this.showInventoryModal = false
        })
        .catch(err => console.log(err))
    },

    showToast(message, type = 'is-success') {
      this.$buefy.toast.open({
        message: message,
        type: type,
        position: 'is-bottom'
      })
    },

    removeActionButtions() {
      this.$store.commit('SET_ACTION_BUTTONS', [])
    },

    setActionButtons() {
      const addInventoryBtn = {
        type: 'is-info',
        icon: 'package-variant',
        label: 'Agregar al inventario',
        action: () => {
          if (!this.checkedProducts || !this.checkedProducts.length) {
            return this.$buefy.dialog.alert({
              title: 'Advertencia',
              message: `Primero debes seleccionar uno o más productos.`,
              type: 'is-warning',
              hasIcon: true,
              iconPack: 'mdi',
              icon: 'alert',
              ariaRole: 'alertdialog',
              ariaModal: true
            })
          }
          this.showInventoryModal = !this.showInventoryModal
        }
      }

      const addProductBtn = {
        type: 'is-success',
        icon: 'plus',
        label: 'Nuevo',
        action: () => {
          this.showForm = true
        }
      }

      this.$store.commit('SET_ACTION_BUTTONS', [addInventoryBtn, addProductBtn])
    }
  },

  mounted() {
    this.setActionButtons()
    this.getProducts()
    this.getInventories()
  },

  beforeDestroy() {
    this.removeActionButtions()
  }
}
</script>

<style lang="scss" scoped>
.tag {
  margin-right: 2px;
}
.search-form {
  width: 200px;
  margin-bottom: 8px;
}
</style>
